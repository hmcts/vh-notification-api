# Set variables once
variables:
  - group: vh-wowza-dev
  - group: cvp-wowza-sbox
  - name: solutionType
    value : DotNetCore # angularDotNetCore, dotNetCore, angular
  - name: apiDirectory
    value : 'NotifyAPI/Notify.API'
  - name: sonarCloudExtraProperties
    value : |
      sonar.cs.opencover.reportsPaths=$(Common.TestResultsDirectory)\Coverage\coverage.opencover.xml
      sonar.coverage.exclusions=**/Program.cs, **/Startup.cs, **/Notify.API/Extensions/**, **/Notify.API/Swagger/**, **/Notify.API/ConfigureServicesExtensions.cs, **/Testing.Common/**, **/Testing.Common/Helper/, **/Testing.Common/Helper/Builders/Api, **/Testing.Common/Helper/Builders/Domain, **/NotifyApi.Common/**, **/NotifyApi.DAL/Mappings/**, **/NotifyApi.DAL/SeedData/**, **/NotifyApi.DAL/NotifyApiDbContext.cs, **/NotifyApi.DAL/**/DesignTimeHearingsContextFactory.cs, **/NotifyApi.DAL/Migrations/**, **/NotifyApi.Domain/Ddd/**, **/NotifyApi.Domain/Validations/**, **/NotifyApi.Services/**, **/NotifyApi.Events/Hub/EventHubClient.cs, **/Notify.API/KinlyApiTokenDelegatingHandler.cs
      sonar.cpd.exclusions="**/NotifyApi.DAL/Migrations/**"
  - name: coverletCoverageExclusions
    value : '[*]Notify.API.Extensions.*,[Notify.API]Notify.API.ConfigureServicesExtensions,[Notify.API]Notify.API.Startup,[Notify.API]Notify.API.Program,[*]Notify.API.Swagger.*,[NotifyApi.*Tests?]*,[*]NotifyApi.DAL.SeedData.*,[*]NotifyApi.DAL.Migrations.*,[*]NotifyApi.DAL.Mappings.*,[*]NotifyApi.Domain.Ddd.*,[*]NotifyApi.Domain.Validations.*,[NotifyApi.DAL]NotifyApi.DAL.NotifyApiDbContext,[NotifyApi.DAL]NotifyApi.DAL.DesignTimeHearingsContextFactory,[*]NotifyApi.Common.*,[*]Testing.Common.*'
  - name: integrationTestsAppSettingsTransform
    value : '
      "AzureAd/TenantId":"$(tenantid)",
      "AzureAd/ClientId":"$(vh-notify-api-appid)",
      "AzureAd/ClientSecret":"$(vh-notify-api-key)",
      "ServiceBusQueue/ConnectionString":"$(AzureServiceBusConnectionStringSend)",
      "Services/KinlyApiUrl":"$(KinlyApiUrl)",
      "Services/KinlySelfTestApiUrl":"$(KinlySelfTestApiUrl)",
      "Services/CallbackUri":"$(CallbackUri)",
      "Services/PexipNode":"$(PexipNode)",
      "Services/ConferenceUsername":"$(ConferenceUsername)",
      "Services/PexipSelfTestNode":"$(PexipSelfTestNode)",
      "Services/UserApiUrl":"$(UserApiUrl)",
      "Services/UserApiResourceId":"$(vh-user-api-identifieruris)",
      "Services/VhNotifyApiResourceId":"$(vh-notify-api-identifieruris)",
      "Services/VhNotifyWebClientId":"$(vh-notify-web-appid)",
      "WowzaConfiguration/RestApiEndpoints":"$(wowza_restApiEndpoints)",
      "WowzaConfiguration/StreamingEndpoint":"$(wowza_streamingEndpoint)",
      "WowzaConfiguration/ServerName":"$(wowza_serverName)",
      "WowzaConfiguration/HostName":"$(wowza_hostName)",
      "WowzaConfiguration/Username":"$(wowza_userName)",
      "WowzaConfiguration/Password":"$(wowza_password)",
      "WowzaConfiguration/StorageDirectory":"$(wowza_storageDirectory)",
      "WowzaConfiguration/StorageAccountName":"$(wowza_storageAccountName)",
      "WowzaConfiguration/StorageAccountKey":"$(wowza_storageAccountKey)",
      "WowzaConfiguration/StorageContainerName":"$(wowza_storageContainerName)",
      "WowzaConfiguration/StorageEndpoint":"$(wowza_storageEndpoint)",
      "WowzaConfiguration/ManagedIdentityClientId":"$(wowza_managedIdentityClientId)",
      "CvpConfiguration/StorageAccountName":"$(cvp_storageAccountName)",
      "CvpConfiguration/StorageAccountKey":"$(cvp_storageAccountKey)",
      "CvpConfiguration/StorageContainerName":"$(cvp_storageContainerName)",
      "CvpConfiguration/StorageEndpoint":"$(cvp_storageEndpoint)",
      "CvpConfiguration/ManagedIdentityClientId":"$(wowza_managedIdentityClientId)"
      '
  - name: dalWorkingDirectory
    value : 'NotifyAPI/NotifyApi.DAL'
  - name: keyVaultName
    value : vhcoreinfrahtdev # Used to get secrets for integration tests
  - name: secretsFilter
    value : 'vh-admin-web-appid,vh-admin-web-key,tenantid,vh-notify-api-identifieruris,vh-notify-web-appid,vh-notify-api-appid,vh-notify-api-key,vh-user-api-identifieruris' # filters out secrets returned from key vault
  - name: infraKeyVaultName
    value : 'vhcoreinfradev'
  - name: infraSecretsFilter
    value : 'vh-core-infra-AppInsightsKey,VhNotifyDatabaseConnectionString,AzureServiceBusConnectionStringSend'

# GitHub Repo that conatins build templates. Reference https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=vsts#using-other-repositories
resources:
  repositories:
  - repository: azureDevOpsTemplates
    type: github
    name: hmcts/azure-devops-templates
    ref: refs/heads/master # ref name to use, defaults to 'refs/heads/master'
    endpoint: hmcts_shaed

trigger:
  branches:
    include:
    - master
    - release/*
    - hotfix/*
    
pr:
  - master

jobs:
  
- template: jobs/angularDotNetCore.yml@azureDevOpsTemplates # Template reference
  parameters:
    sonarCloudExtraProperties: $(sonarCloudExtraProperties)
    integrationTestsAppSettingsTransform: $(integrationTestsAppSettingsTransform)
    coverletCoverageExclusions: $(coverletCoverageExclusions)
    apiDirectory: $(apiDirectory)
    dalWorkingDirectory: $(dalWorkingDirectory)
    keyVaultName: $(keyVaultName)
    secretsFilter: $(secretsFilter),
    infraKeyVaultName: $(infraKeyVaultName)
    infraSecretsFilter: $(infraSecretsFilter)
    dotNetCoreVersion: '3.1.100'
